{% extends 'base.html' %}

{% block head %}
    <title>Workshop Parts Tracker</title>
{% endblock %}

{% block body %}
    <p style="text-align: center; margin-bottom: 10px;">
        <a href="/view_deleted_parts">View Deleted Parts</a>
    </p>

    <div class="description">
        <h1 style="text-align: center">Workshop Parts Tracker</h1>
        <table>
            <tr>
                <th>Part ID</th>
                <th>Description</th>
                <th>Location</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>

            {% for part in parts %}
                <tr>
                    <td>{{ part.id }}</td>

                    <td class="wrap-text desc" data-id="{{ part.id }}">
                        {{ part.description }}
                    </td>

                    <td class="wrap-text loc" data-id="{{ part.id }}">
                        {{ part.location }}
                    </td>

                    <td>{{ part.date_created.date() }}</td>

                    <td>
                        <button class="edit-btn" data-id="{{ part.id }}">Update</button>
                        <button class="cancel-btn" data-id="{{ part.id }}" style="display: none;">Cancel</button>
                        <button class="save-btn" data-id="{{ part.id }}" style="display: none;">Save</button>
                        <a href="{{ url_for('parts.delete_part', id=part.id) }}">Delete</a>
                    </td>
                </tr>
            {% endfor %}
        
            <tr>
                <form action="/" method="POST">
                    <td>-</td>
                    <td><input type="text" name="description" id="description" required></td>
                    <td><input type="text" name="location" id="location" required></td>
                    <td>-</td>
                    <td><input type="submit" value="Add Part"></td>
                </form>
            </tr>
        </table>
        
        {% if parts|length < 1 %}
            <h4 style="text-align: center;">It's lonely in here. Won't you create a part, please?</h4>
        {% endif %}
    </div>
       
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        document.addEventListener('click', function (event) {
            const target = event.target;
            const id = target.dataset.id;

            // Handle Edit
            if (target.classList.contains('edit-btn')) {
                const descTd = document.querySelector(`.desc[data-id="${id}"]`);
                const locTd = document.querySelector(`.loc[data-id="${id}"]`);

                const currentDesc = descTd.textContent.trim();
                const currentLoc = locTd.textContent.trim();

                descTd.innerHTML = `<input type="text" value="${currentDesc}" style="width: 90%;">`;
                locTd.innerHTML = `<input type="text" value="${currentLoc}" style="width: 90%;">`;

                target.style.display = 'none';
                document.querySelector(`.cancel-btn[data-id="${id}"]`).style.display = 'inline-block';
                document.querySelector(`.save-btn[data-id="${id}"]`).style.display = 'inline-block';
            }

            // Handle Cancel
            else if (target.classList.contains('cancel-btn')) {
                window.location.reload(); // quick way to revert
            }

            // Handle Save
            else if (target.classList.contains('save-btn')) {
                const descInput = document.querySelector(`.desc[data-id="${id}"] input`);
                const locInput = document.querySelector(`.loc[data-id="${id}"] input`);

                const newDesc = descInput.value;
                const newLoc = locInput.value;

                fetch(`/update-inline/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        description: newDesc,
                        location: newLoc
                    })
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Update failed');
                    }
                });
            }
        });
    });
    </script>

{% endblock %}

